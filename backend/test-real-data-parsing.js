const GalileoskyParser = require('./src/services/parser');
const logger = require('./src/utils/logger');

// Real hex data from your logs - this should contain 47 records
const realHexData = "01400B20F57E78682105003010D705A1FFB7925B063300000000342C0040090B413800426D0D450F00460000500000510000520000E200000000E300000000207D7E786821F300300EB207A1FF9D925B06332C00000034240040090B413B00428A0D450F00460000500000510000520000E200000000E300000000203D7E786821B502300FCD07A1FFB6925B063300005103341F0040090B413D2242DE0D450F00460000500000510000520000E200000000E30000000020357E7868213401300FCB07A1FF9E925B06333000A303341F0040090A41383542DE0D450F00460000500000510000520000E200000000E30000000020337E786821D001300FCD07A1FF87925B06332E001604341F0040090A414A3542DE0D450F00460000500000510000520000E200000000E30000000020117E7868212501300F4808A1FF3C925B06332E00AC0434210040090A41F93442DF0D450F00460000500000510000520000E200000000E300000000200F7E786821BF01300F5108A1FF26925B06333900CC0334220040090A41FD3442DF0D450F00460000500000510000520000E200000000E30000000020067E786821B301300F3808A1FF1D915B063389000E0334230040090A41213542DF0D450F00460000500000510000520000E200000000E30000000020047E7868213B00300F2A08A1FFC3905B063372007D0334240040090A41253542DF0D450F00460000500000510000520000E200000000E30000000020037E7868211500300F2A08A1FFA9905B06337000A60334240040090A41313542DF0D450F00460000500000510000520000E200000000E30000000020027E7868215400300F2C08A1FF91905B06335C00230434240040090A413A3542DF0D450F00460000500000510000520000E200000000E30000000020017E7868212F00300F2F08A1FF7D905B06334F008D0434240040090A413D3542DF0D450F00460000500000510000520000E200000000E30000000020007E7868218600300F3608A1FF6D905B06334200200534240040090A411D3542DF0D450F00460000500000510000520000E200000000E30000000020FF7D786821DF00300F3E08A1FF61905B06333B009B0534240040090A41243542DF0D450F00460000500000510000520000E200000000E30000000020FE7D7868213601300F4A08A1FF57905B06333200890634240040090A412A3542DF0D450F00460000500000510000520000E200000000E30000000020FD7D786821F401300F5408A1FF54905B06333B000C0734240040090A41273542DF0D450F00460000500000510000520000E200000000E30000000020FC7D7868214D02300F6308A1FF52905B06334200740734240040090A413F3542DF0D450F00460000500000510000520000E200000000E30000000020FB7D786821A502300F7208A1FF54905B06334F00D90734240040090A41573542DF0D450F00460000500000510000520000E200000000E30000000020FA7D786821FE02300F8408A1FF57905B06335800530834240040090A41533542DF0D450F00460000500000510000520000E200000000E30000000020F97D7868215703300F9708A1FF5F905B06336000EA0834240040090A413B3542DF0D450F00460000500000510000520000E200000000E30000000020F87D786821AF03300FA608A1FF70905B06336B00C80934240040090A41003542DF0D450F00460000500000510000520000E200000000E30000000020F67D7868213401300FB508A1FFD2905B0633E100700A34240040090A413E3542DF0D450F00460000500000510000520000E200000000E30000000020F17D786821E202300FE308A1FF1C925B06334701080A34240040090A412E3542DF0D450F00460000500000510000520000E200000000E30000000020EE7D786821B400300F3D09A1FF3E935B06336901A00934250040090A41223542DF0D450F00460000500000510000520000E200000000E30000000020E97D7868217A02300FF109A1FF9B945B06333E013B0934250040090A411A3542E00D450F00460000500000510000520000E200000000E30000000020E37D7868215B01300F3D0BA1FF24965B06337901BE0834270040090A413B3542E00D450F00460000500000510000520000E200000000E30000000020DA7D7868219C01300FD40DA1FF2C985B06336501500834260040090A410B3542E00D450F00460000500000510000520000E200000000E30000000020D37D786821DA00300FE60FA1FF5D995B06333A01EB0734260040090A41253542E00D450F00460000500000510000520000E200000000E30000000020D17D7868217501300F6A10A1FF8A995B06331F01860734260040090A412E3542E00D450F00460000500000510000520000E200000000E30000000020CF7D7868212902300FE710A1FF99995B06330A01DD0634260040090A41283542E00D450F00460000500000510000520000E200000000E30000000020CD7D786821DD02300F5811A1FF87995B0633F400540634260040090A41443542E00D450F00460000500000510000520000E200000000E30000000020CC7D7868210E00300FC011A1FF5B995B0633F800CC0534260040090A41623542E00D450F00460000500000510000520000E200000000E30000000020CA7D786821AA00300F1D12A1FF17995B06330C01500534260040090A416C3542E00D450F00460000500000510000520000E200000000E30000000020C87D7868215D01300F6F12A1FFB8985B06332C01AC0434270040090A415D3542E00D450F00460000500000510000520000E200000000E30000000020C67D7868211202300FA712A1FF39985B06333701240434270040090A41503542E00D450F00460000500000510000520000E200000000E30000000020C27D786821CA03300FCF12A1FF11975B06337201A90334270040090A41383542E00D450F00460000500000510000520000E200000000E30000000020BD7D7868215102300F2413A1FFF0945B0633B5011C0434280040090A413A3542E00D450F00460000500000510000520000E200000000E30000000020B67D7868219101300F5914A1FF11925B06339901980434270040090A41393542E00D450F00460000500000510000520000E200000000E30000000020B47D7868214602300FA414A1FF6C915B06338A01300434270040090A41463542E00D450F00460000500000510000520000E200000000E30000000020B27D786821DF02300FCA14A1FFBE905B06338401A50334270040090A41413542E00D450F00460000500000510000520000E200000000E300000000209C7D786821E100300FA113A1FF8B865B0633C901400334250040090A415C3542E00D450F00460000500000510000520000E200000000E30000000020797D7868219200300F9512A1FF337A5B0633E900860334270040090A413D3542E00D450F00460000500000510000520000E200000000E30000000020707D786821D300300F0D13A1FF26785B0633EB00100434260040090A413A3542E00D450F00460000500000510000520000E200000000E300000000206C7D7868212502300F2E13A1FF54775B0633DE00960334260040090A415E3542E00D450F00460000500000510000520000E200000000E30000000020687D7868215000300F2113A1FF58765B0633D4001F0334260040090A41533542E00D450F00460000500000510000520000E200000000E30000000020647D786821BB01300FED12A1FF9A755B0633F600AB0234260040090A415D3542E00D450F00460000500000510000520000E200000000E30000000020537D7868219701300DBE0FA1FF4A705B0633BC01470234260040090A41183542E00D450F00460000500000510000520000E200000000E300000000204D7D786821A103300F6A0EA1FF6F6E5B06339B01DE0134260040090A41293542E00D450F00460000500000510000520000E200000000E300000000B0E1";

// Convert hex string to buffer
const realDataBuffer = Buffer.from(realHexData, 'hex');

async function testRealDataParsing() {
    console.log('=== Real Data Multi-Record Parsing Test ===\n');
    
    const parser = new GalileoskyParser();
    const testConnection = '103.149.224.66:50153'; // From your logs
    
    console.log('Testing with real hex data from your logs...');
    console.log(`Hex data length: ${realHexData.length} characters`);
    console.log(`Buffer length: ${realDataBuffer.length} bytes`);
    console.log(`Expected records: 47 (based on your manual count)`);
    console.log('');
    
    try {
        const result = await parser.parse(realDataBuffer, testConnection);
        
        console.log('=== PARSING RESULTS ===');
        console.log(`✅ Parsed ${result.records.length} records`);
        console.log(`Expected: 47 records`);
        console.log(`Actual: ${result.records.length} records`);
        
        if (result.records.length === 47) {
            console.log('✅ SUCCESS: All 47 records parsed correctly!');
        } else if (result.records.length > 0) {
            console.log(`⚠️  PARTIAL SUCCESS: Parsed ${result.records.length}/47 records`);
        } else {
            console.log('❌ FAILED: No records parsed');
        }
        
        console.log('\n=== RECORD DETAILS ===');
        result.records.forEach((record, index) => {
            console.log(`Record ${index + 1}: ${Object.keys(record.tags).length} tags`);
            console.log(`  Tags: ${Object.keys(record.tags).join(', ')}`);
            
            // Show some key tag values
            if (record.tags['0x20']) {
                console.log(`  DateTime: ${record.tags['0x20'].value}`);
            }
            if (record.tags['0x30']) {
                const coords = record.tags['0x30'].value;
                if (coords && coords.latitude && coords.longitude) {
                    console.log(`  Coordinates: ${coords.latitude}, ${coords.longitude}`);
                }
            }
            if (record.tags['0x33']) {
                const speedDir = record.tags['0x33'].value;
                if (speedDir && speedDir.speed) {
                    console.log(`  Speed: ${speedDir.speed} km/h`);
                }
            }
            console.log('');
        });
        
        // Summary statistics
        console.log('=== SUMMARY STATISTICS ===');
        const tagCounts = {};
        result.records.forEach(record => {
            Object.keys(record.tags).forEach(tag => {
                tagCounts[tag] = (tagCounts[tag] || 0) + 1;
            });
        });
        
        console.log('Tag frequency across all records:');
        Object.entries(tagCounts)
            .sort(([,a], [,b]) => b - a)
            .forEach(([tag, count]) => {
                console.log(`  ${tag}: ${count} records`);
            });
        
    } catch (error) {
        console.log(`❌ Test FAILED with error: ${error.message}`);
        console.log('Stack trace:', error.stack);
    }
}

// Run the test
testRealDataParsing().catch(error => {
    console.error('Test execution failed:', error);
    process.exit(1);
}); 